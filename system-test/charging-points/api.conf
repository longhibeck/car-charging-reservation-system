server {
    listen 80;
    server_name _;

    # Exact match for collection endpoints
    location = /api/v1/charging-points {
        root /usr/share/nginx/html;
        try_files /data.json =404;
        default_type application/json;
        add_header Access-Control-Allow-Origin *;
        add_header Access-Control-Allow-Methods "GET, OPTIONS";
        add_header Access-Control-Allow-Headers "Content-Type, Authorization";
    }

    location = /api/v1/charging-points/ {
        root /usr/share/nginx/html;
        try_files /data.json =404;
        default_type application/json;
        add_header Access-Control-Allow-Origin *;
        add_header Access-Control-Allow-Methods "GET, OPTIONS";
        add_header Access-Control-Allow-Headers "Content-Type, Authorization";
    }

    # Prefix match for individual charging points
    location ^~ /api/v1/charging-points/ {
        default_type application/json;
        add_header Access-Control-Allow-Origin *;
        add_header Access-Control-Allow-Methods "GET, OPTIONS";
        add_header Access-Control-Allow-Headers "Content-Type, Authorization";

        content_by_lua_block {
            local cjson = require "cjson"
            local io = require "io"
            
            -- Extract ID from URI
            local uri = ngx.var.uri
            local id = string.match(uri, "/api/v1/charging%-points/([^/]+)")
            
            if not id then
                ngx.status = 400
                ngx.say('{"error": "Invalid charging point ID"}')
                return
            end
            
            ngx.log(ngx.ERR, "Looking for charging point: " .. id)
            
            -- Read and parse JSON
            local file = io.open("/usr/share/nginx/html/data.json", "r")
            if not file then
                ngx.status = 500
                ngx.say('{"error": "Could not read data file"}')
                return
            end
            
            local content = file:read("*all")
            file:close()
            
            local ok, data = pcall(cjson.decode, content)
            if not ok then
                ngx.status = 500
                ngx.say('{"error": "Invalid JSON format"}')
                return
            end
            
            -- Find charging point
            for _, point in ipairs(data) do
                if point.id == id then
                    ngx.say(cjson.encode(point))
                    return
                end
            end
            
            -- Not found
            ngx.status = 404
            ngx.say('{"error": "Charging point not found", "id": "' .. id .. '"}')
        }
    }
}